<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bestias | Organizador y Buscador</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root{
        --bg: #f4f6f8;
        --surface: #ffffff;
        --text: #1f2937;
        --muted: #6b7280;
        --primary: #2563eb;
        --border: #e5e7eb;
        --shadow: 0 8px 20px rgba(0,0,0,0.06);
        /* Colores por categor√≠a (suaves) */
        --cat1-bg: #e0f2fe; --cat1-fg: #075985;
        --cat2-bg: #fef3c7; --cat2-fg: #854d0e;
        --cat3-bg: #e9d5ff; --cat3-fg: #6b21a8;
        --cat4-bg: #dcfce7; --cat4-fg: #166534;
      }
      *{box-sizing:border-box}
      html,body{height:100%}
      body{
        margin:0;
        background:var(--bg);
        color:var(--text);
        font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", sans-serif;
      }

      .app{
        display:grid;
        grid-template-columns: 260px 1fr;
        min-height:100dvh;
      }
      aside.sidebar{
        background:var(--surface);
        border-right:1px solid var(--border);
        padding:20px;
      }
      .brand{
        font-weight:700;
        font-size:1.2rem;
        margin-bottom:12px;
      }
      .cat-list{
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .cat-btn{
        appearance:none;
        border:1px solid var(--border);
        background:#fff;
        padding:10px 12px;
        border-radius:10px;
        text-align:left;
        cursor:pointer;
        font-weight:600;
        transition: border-color .2s, box-shadow .2s, transform .04s;
      }
      .cat-btn:hover{border-color:#cbd5e1}
      .cat-btn.active{
        border-color:#a3bffa;
        box-shadow:0 0 0 3px rgba(37,99,235,0.15);
      }
      .cat-hint{color:var(--muted); font-size:.9rem; margin-top:8px}
      .nav-section{ margin-top:18px }
      .nav-title{ font-weight:700; margin:14px 0 8px 0 }
      .nav-link{
        display:block; border:1px solid var(--border); background:#fff; padding:10px 12px;
        border-radius:10px; text-align:left; cursor:pointer; font-weight:600; text-decoration:none; color:inherit; margin-bottom:8px;
        transition: border-color .2s, box-shadow .2s, transform .04s;
      }
      .nav-link:hover{ border-color:#cbd5e1 }

      main.content{
        padding:20px;
      }
      .toolbar{
        display:flex;
        gap:12px;
        flex-wrap:wrap;
        align-items:center;
        margin-bottom:12px;
      }
      .search{
        flex:1 1 260px;
        display:flex;
        align-items:center;
        gap:8px;
        background:var(--surface);
        border:1px solid var(--border);
        border-radius:10px;
        padding:10px 12px;
      }
      .search input{
        flex:1;
        border:none;
        outline:none;
        font-size:1rem;
        background:transparent;
      }
      .sel, .btn, .num{
        background:var(--surface);
        border:1px solid var(--border);
        border-radius:10px;
        padding:10px 12px;
        font-size: .95rem;
      }
      .btn{
        cursor:pointer;
        font-weight:600;
      }
      .btn.primary{
        background:#eef2ff;
        border-color:#c7d2fe;
        color:#3730a3;
      }
      .filters{
        background:var(--surface);
        border:1px solid var(--border);
        border-radius:12px;
        padding:10px 12px;
      }
      .filters summary{cursor:pointer; font-weight:700}
      .filters-grid{
        display:grid;
        grid-template-columns: repeat(5, minmax(160px,1fr));
        gap:12px;
        margin-top:10px;
      }
      .filters-field{
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap:8px;
      }
      .filters label{font-size:.85rem; color:var(--muted)}

      .results-bar{
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin:14px 0;
        color:var(--muted);
        font-size:.95rem;
      }

      .cards{
        display:grid;
        grid-template-columns: repeat(3, minmax(280px, 1fr));
        gap:16px;
      }

      .card{
        background:var(--surface);
        border:1px solid var(--border);
        border-radius:16px;
        box-shadow: var(--shadow);
        overflow:hidden;
        transition: box-shadow .2s, transform .04s;
        cursor:pointer;
      }
      .card:hover{box-shadow:0 12px 28px rgba(0,0,0,0.10)}
      .card-header{
        display:grid;
        grid-template-columns: 120px 1fr;
        gap:12px;
        padding:12px;
        border-bottom:1px solid var(--border);
        align-items:center;
      }
      .card-img{
        width:100%;
        height:100%;
        max-height:96px;
        object-fit:cover;
        border-radius:10px;
        background:#f1f5f9;
      }
      .card-title{
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .name{
        font-weight:800;
        font-size:1.05rem;
      }
      .badge{
        display:inline-flex;
        align-items:center;
        gap:8px;
        font-size:.85rem;
        font-weight:700;
        width:max-content;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid transparent;
      }
      .badge.cat1{ background:var(--cat1-bg); color:var(--cat1-fg); border-color:#bae6fd }
      .badge.cat2{ background:var(--cat2-bg); color:var(--cat2-fg); border-color:#fde68a }
      .badge.cat3{ background:var(--cat3-bg); color:var(--cat3-fg); border-color:#d8b4fe }
      .badge.cat4{ background:var(--cat4-bg); color:var(--cat4-fg); border-color:#bbf7d0 }

      .card-body{
        padding:16px;
      }
      .stats{
        display:grid;
        grid-template-columns: repeat(3, minmax(0,1fr));
        gap:16px;
      }
      .stat{
        background:#f8fafc;
        border:1px solid var(--border);
        border-radius:12px;
        padding:10px;
        font-size:.93rem;
      }
      .stat b{display:block; font-size:.78rem; color:var(--muted); margin-bottom:4px}

      .extra{
        margin-top:12px;
        display:none;
      }
      .card.expanded .extra{ display:block }

      .empty{
        background:#fff;
        border:1px dashed var(--border);
        color:var(--muted);
        border-radius:12px;
        padding:18px;
        text-align:center;
      }

      .card > .stats, .card > .extra{ padding:16px; box-sizing:border-box }
      .card-body > .stats, .card-body > .extra{ padding:8px; box-sizing:border-box }
      .stat{ display:flex; flex-direction:column; justify-content:center; min-height:88px; min-width:0; word-break:break-word }
      .stat b{ white-space:normal; overflow-wrap:anywhere; word-break:break-word }
      .stat .value, .stat .stat-value{
        display:block; overflow-wrap:anywhere; word-break:break-word; max-width:100%; white-space:normal; overflow:visible
      }

      .overlay{
        position:fixed;inset:0;background:rgba(0,0,0,.35);
        opacity:0;pointer-events:none;transition:opacity .2s;z-index:20
      }
      .overlay.show{opacity:1;pointer-events:auto}

      @media (max-width: 1024px){
        .app{ grid-template-columns: 1fr }
        aside.sidebar{ position:fixed; left:0; top:0; bottom:0; width:86vw; max-width:320px; transform:translateX(-100%); transition:transform .25s; z-index:30 }
        aside.sidebar.open{ transform:translateX(0) }
        .cards{ grid-template-columns: repeat(2, minmax(240px, 1fr)) }
      }
      @media (max-width: 640px){
        .cards{ grid-template-columns: 1fr }
        .filters-grid{ grid-template-columns: repeat(2, minmax(140px,1fr)) }
        .stats{ grid-template-columns: 1fr 1fr }
        .card-header{ grid-template-columns: 100px 1fr }
      }
      @media (max-width: 480px){
        .stats{ grid-template-columns: 1fr }
      }
    </style>
  </head>
  <body>
    <div class="app">
      <aside id="sidebar" class="sidebar">
        <div class="brand">Bestias</div>
        <div class="cat-list" id="catList">
          <button class="cat-btn active" data-cat="Todas">Todas</button>
          <button class="cat-btn" data-cat="Categor√≠a 1">Categor√≠a 1</button>
          <button class="cat-btn" data-cat="Categor√≠a 2">Categor√≠a 2</button>
          <button class="cat-btn" data-cat="Categor√≠a 3">Categor√≠a 3</button>
          <button class="cat-btn" data-cat="Categor√≠a 4">Categor√≠a 4</button>
        </div>
        <div class="nav-section">
          <div class="nav-title">Personajes</div>
          <a class="nav-link" href="plantillas.html">Plantillas de Fichas</a>
          <a class="nav-link" href="tus_fichas.html">Tus fichas</a>
        </div>
        <a class="nav-link" href="tus_bestias.html">Tus bestias</a>
      </aside>
      <div id="overlay" class="overlay"></div>
      <main class="content">
        <div class="toolbar">
          <button id="openSidebarBtn" class="btn" aria-controls="sidebar" aria-expanded="false">Men√∫</button>
          <div class="search">
            <span>üîé</span>
            <input id="searchInput" type="search" placeholder="Buscar por nombre..." aria-label="Buscar bestias por nombre" />
          </div>
          <button id="clearBtn" class="btn">Limpiar filtro</button>
        </div>

        <div class="filters">
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <strong>¬øNecesitas m√°s filtros?</strong>
            <a class="btn primary" href="filtros.html" aria-label="Ir a b√∫squeda avanzada">B√∫squeda avanzada</a>
          </div>
        </div>

        <div class="results-bar">
          <div id="resultCount">0 resultados</div>
          <div>Haz clic en una tarjeta para ver todos los detalles</div>
        </div>

        <div class="cards" id="cards"></div>
      </main>
    </div>

    <script src="data.js"></script>
    <script>
      const bestias = Array.isArray(window.bestias) ? window.bestias : [];

      // ===============================
      // Estado y referencias de UI
      // ===============================
      const cardsEl = document.getElementById('cards');
      const resultCountEl = document.getElementById('resultCount');
      const searchInput = document.getElementById('searchInput');
      const sortAttr = document.getElementById('sortAttr');
      const sortDir = document.getElementById('sortDir');
      const clearBtn = document.getElementById('clearBtn');
      const catList = document.getElementById('catList');
      const sidebarEl = document.getElementById('sidebar');
      const overlayEl = document.getElementById('overlay');
      const openSidebarBtn = document.getElementById('openSidebarBtn');
      const filters = null; // filtros avanzados se usan en filtros.html
      let currentCategory = 'Todas';

      const attrMap = {
        nombre: 'nombre',
        dano: 'dano',
        ca: 'ca',
        vitalidad: 'vitalidad',
        px: 'px',
        movimiento: 'movimiento',
        dano_alcance: 'dano_alcance'
      };

      // ===============================
      // L√≥gica de filtrado y orden
      // ===============================
      function norm(s){
        return String(s || '')
          .trim()
          .toLowerCase()
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g,'');
      }
      function num(val){
        const n = Number(val);
        return Number.isFinite(n) ? n : null;
      }
      // Analizador de da√±o D&D 5e
      // - Formatos v√°lidos: "XdY" o "XdY + AdB + ..." (con o sin espacios alrededor del '+')
      // - Dados permitidos: d3, d4, d6, d8, d10, d12, d20, d100
      // - No admite modificadores planos (+3), multiplicadores ni restas
      // - Ignora descripciones entre par√©ntesis en el texto original (p. ej. "(Mordisco)")
      // Devuelve un objeto con { min, max, average } o null si el formato es inv√°lido
      function parseDamage(expr){
        const facesAllowed = ['3','4','6','8','10','12','20','100'];
        if (typeof expr !== 'string') return null;
        const cleaned = expr
          .toLowerCase()
          .replace(/\([^)]*\)/g,'')        // quitar descripciones entre par√©ntesis
          .trim();
        if (!cleaned) return null;
        const valid = /^\s*(\d+\s*d\s*(3|4|6|8|10|12|20|100))(\s*\+\s*\d+\s*d\s*(3|4|6|8|10|12|20|100))*\s*$/.test(cleaned);
        if (!valid) return null;
        let min = 0, max = 0, avg = 0;
        const re = /(\d+)\s*d\s*(3|4|6|8|10|12|20|100)/g;
        let m;
        while ((m = re.exec(cleaned))){
          const count = Number(m[1]);
          const faces = Number(m[2]);
          if (!Number.isFinite(count) || count<=0) return null;
          if (!facesAllowed.includes(String(faces))) return null;
          min += count * 1;
          max += count * faces;
          avg += count * ((faces + 1) / 2);
        }
        return { min, max, average: avg };
      }
      // Obtiene el valor promedio de da√±o de una bestia
      // - Usa 'dano_texto' si el formato es v√°lido
      // - Si no, recurre a 'dano' num√©rico como fallback
      function damageAverageOf(b){
        const stats = parseDamage(b.dano_texto||'');
        if (stats) return stats.average;
        const n = Number(b.dano);
        return Number.isFinite(n) ? n : null;
      }
      // Obtiene los stats de da√±o para filtros avanzados (o null si no se pueden calcular)
      function damageStatsOf(b){
        const stats = parseDamage(b.dano_texto||'');
        if (stats) return stats;
        const n = Number(b.dano);
        if (Number.isFinite(n)) return { min:n, max:n, average:n };
        return null;
      }
      function bullets(text){
        const s = String(text||'').trim();
        if(!s) return '';
        const parts = s.split(/[.\n;‚Ä¢]+/).map(t=>t.trim()).filter(Boolean);
        return '<ul>' + parts.map(t=>'<li>'+t+'</li>').join('') + '</ul>';
      }
      function fmtPX(v){
        const n = Number(v);
        if (Number.isFinite(n)) return new Intl.NumberFormat('es-ES').format(n);
        return String(v ?? '-');
      }
      function fmtCasillas(v){
        const n = Number(v);
        if (!Number.isFinite(n)) return String(v ?? '-');
        return n + ' ' + (n===1?'Casilla':'Casillas');
      }

      function pasaRango(value, minEl, maxEl){
        const v = Number(value);
        const mn = num(minEl.value);
        const mx = num(maxEl.value);
        if (mn !== null && v < mn) return false;
        if (mx !== null && v > mx) return false;
        return true;
      }

      function filtrar(lista){
        const q = (searchInput.value || '').trim().toLowerCase();
        return lista.filter(b => {
          if (norm(currentCategory) !== 'todas' && (norm(b.categoria) !== norm(currentCategory))) return false;
          if (q && !(b.nombre || '').toLowerCase().includes(q)) return false;
          // filtros avanzados removidos de index; disponibles en filtros.html
          return true;
        });
      }

      function ordenar(lista){
        const key = sortAttr ? attrMap[sortAttr.value] : null;
        const dir = (sortDir && sortDir.value === 'desc') ? -1 : 1;
        if (!key) return lista;
        return [...lista].sort((a,b) => {
          const va = key==='dano' ? damageAverageOf(a) : a[key];
          const vb = key==='dano' ? damageAverageOf(b) : b[key];
          if (key==='dano'){
            const an = typeof va === 'number';
            const bn = typeof vb === 'number';
            if (an && bn) return (va - vb) * dir;
            if (an && !bn) return -1;
            if (!an && bn) return 1;
            return 0;
          } else {
            if (typeof va === 'number' && typeof vb === 'number'){
              return (va - vb) * dir;
            }
            const sa = String(va ?? '').toLowerCase();
            const sb = String(vb ?? '').toLowerCase();
            if (sa < sb) return -1 * dir;
            if (sa > sb) return  1 * dir;
            return 0;
          }
        });
      }

      // ===============================
      // Render de tarjetas
      // ===============================
      function catClass(cat){
        switch(norm(cat)){
          case 'categoria 1': return 'bg-sky-100 text-sky-800 ring-sky-300';
          case 'categoria 2': return 'bg-amber-100 text-amber-800 ring-amber-300';
          case 'categoria 3': return 'bg-violet-100 text-violet-800 ring-violet-300';
          case 'categoria 4': return 'bg-green-100 text-green-800 ring-green-300';
          default: return 'bg-sky-100 text-sky-800 ring-sky-300';
        }
      }

      function crearCard(b){
        const el = document.createElement('article');
        el.className = 'card rounded-2xl shadow-md hover:shadow-lg border border-gray-200 bg-white overflow-hidden transition cursor-pointer';
        el.innerHTML = `
          <div class="card-header">
            <img class="card-img" src="${b.imagen ?? ''}" alt="${b.nombre ?? ''}" />
            <div class="card-title">
              <div class="name">${b.nombre ?? ''}</div>
              <span class="badge ${catClass(b.categoria).replace(/ring-[^\\s]+/,'')}">${b.categoria ?? ''}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="stats">
              <div class="stat bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm">
                <b class="block text-xs text-gray-500 font-semibold mb-1">Da√±o</b>
                <div class="value text-gray-900 font-semibold">${b.dano_texto ?? (b.dano ?? '-')}</div>
              </div>
              <div class="stat bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm">
                <b class="block text-xs text-gray-500 font-semibold mb-1">C.A.</b>
                <div class="value text-gray-900 font-semibold">${b.ca ?? '-'}</div>
              </div>
              <div class="stat bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm">
                <b class="block text-xs text-gray-500 font-semibold mb-1">Vitalidad</b>
                <div class="value text-gray-900 font-semibold">${b.vitalidad ?? '-'}</div>
              </div>
              <div class="stat bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm">
                <b class="block text-xs text-gray-500 font-semibold mb-1">PX</b>
                <div class="value text-gray-900 font-semibold">${fmtPX(b.px)}</div>
              </div>
              <div class="stat bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm">
                <b class="block text-xs text-gray-500 font-semibold mb-1">Movimiento</b>
                <div class="value text-gray-900 font-semibold">${fmtCasillas(b.movimiento)}</div>
              </div>
              <div class="stat bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm">
                <b class="block text-xs text-gray-500 font-semibold mb-1">Rango alcance</b>
                <div class="value text-gray-900 font-semibold">${fmtCasillas(b.dano_alcance)}</div>
              </div>
            </div>
            <div class="extra hidden">
              <div class="mt-3 bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm"><b class="block text-xs text-gray-500 font-semibold mb-1">Fortalezas</b>${bullets(b.fortalezas)}</div>
              <div class="mt-3 bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm"><b class="block text-xs text-gray-500 font-semibold mb-1">Debilidades</b>${bullets(b.debilidades)}</div>
              <div class="mt-3 bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm"><b class="block text-xs text-gray-500 font-semibold mb-1">Localizaci√≥n</b>${b.localizacion ?? ''}</div>
              <div class="mt-3 bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm"><b class="block text-xs text-gray-500 font-semibold mb-1">Alineamiento</b>${b.alineamiento ?? ''}</div>
              <div class="mt-3 bg-slate-50 border border-gray-200 rounded-xl p-3 text-sm"><b class="block text-xs text-gray-500 font-semibold mb-1">Descripci√≥n</b>${b.descripcion ?? ''}</div>
            </div>
          </div>
        `;
        el.addEventListener('click', () => {
          const slug = norm(b.nombre).replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
          location.href = `detalle.html?id=${encodeURIComponent(slug)}`;
        });
        return el;
      }

      function render(){
        cardsEl.innerHTML = '';
        const filtradas = filtrar(bestias);
        const ordenadas = ordenar(filtradas);
        resultCountEl.textContent = `${ordenadas.length} resultado${ordenadas.length!==1?'s':''}`;
        if (ordenadas.length === 0){
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'No hay bestias para mostrar. Agrega tus datos en el JSON.';
          cardsEl.appendChild(empty);
          return;
        }
        for(const b of ordenadas){
          cardsEl.appendChild(crearCard(b));
        }
      }

      function openSidebar(){
        sidebarEl.classList.add('open');
        overlayEl.classList.add('show');
        openSidebarBtn.setAttribute('aria-expanded','true');
      }
      function closeSidebar(){
        sidebarEl.classList.remove('open');
        overlayEl.classList.remove('show');
        openSidebarBtn.setAttribute('aria-expanded','false');
      }

      // ===============================
      // Eventos UI
      // ===============================
      searchInput.addEventListener('input', render);
      if (sortAttr) sortAttr.addEventListener('change', render);
      if (sortDir) sortDir.addEventListener('change', render);
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        if (sortAttr) sortAttr.value = '';
        if (sortDir) sortDir.value = 'asc';
        currentCategory = 'Todas';
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.cat==='Todas'));
        render();
        closeSidebar();
      });

      document.querySelectorAll('.cat-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          currentCategory = btn.dataset.cat;
          document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b===btn));
          render();
          closeSidebar();
        });
      });

      openSidebarBtn.addEventListener('click', openSidebar);
      overlayEl.addEventListener('click', closeSidebar);
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSidebar(); });

      // filtros avanzados no disponibles en index

      // Primera renderizaci√≥n (lista vac√≠a)
      render();
    </script>
  </body>
</html>
