<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tus fichas</title>
    <style>
      :root{ --bg:#f4f6f8; --surface:#fff; --text:#111827; --border:#e5e7eb }
      body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
      .wrap{max-width:900px;margin:0 auto;padding:20px}
      .card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px}
      h1{margin:0;font-size:1.6rem;font-weight:800}
      .btn-back{display:inline-block;background:#eef2ff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;text-decoration:none;color:#3730a3;font-weight:600}
      .back{margin-bottom:12px;display:flex}
      .fichas-list{display:grid;gap:10px}
      .ficha-item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--surface)}
      .btn{display:inline-block;background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 12px;text-decoration:none;color:#111827;font-weight:600}
      @media (prefers-color-scheme: dark){
        :root{ --bg:#0f172a; --surface:#0b1020; --text:#e5e7eb; --border:#334155 }
        body{background:var(--bg);color:var(--text)}
        .btn{background:#0f172a;color:#e5e7eb;border-color:#334155}
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="back">
        <a class="btn-back" href="index.html">← Volver</a>
      </div>
      <div class="card">
        <h1>Tus fichas</h1>
      </div>
      <div class="card" style="margin-top:12px">
        <h2 style="margin:0 0 10px 0">Fichas guardadas</h2>
        <div id="fichas-list" class="fichas-list"></div>
      </div>
    </div>
    <script>
      (function(){
        const LIST_KEY = 'fichas-personaje';
        const SINGLE_KEY = 'ficha-personaje';
        function getList(){
          const raw = localStorage.getItem(LIST_KEY);
          let arr = [];
          try{ arr = JSON.parse(raw||'[]') || []; }catch(e){ arr = []; }
          if(Array.isArray(arr) && arr.length) return arr;
          const sraw = localStorage.getItem(SINGLE_KEY);
          if(sraw){
            try{
              const data = JSON.parse(sraw||'{}');
              return [{ id:'last', createdAt: Date.now(), updatedAt: Date.now(), data, personaje: data['personaje']||'', jugador: data['jugador']||'' }];
            }catch(e){}
          }
          return [];
        }
        function setList(arr){
          localStorage.setItem(LIST_KEY, JSON.stringify(Array.isArray(arr)?arr:[]));
        }
        function download(item){
          const blob = new Blob([JSON.stringify(item.data||{},null,2)], {type:'application/json'});
          const a = document.createElement('a');
          const name = (item.personaje && String(item.personaje).trim()) || 'ficha-personaje';
          a.href = URL.createObjectURL(blob);
          a.download = name + '.json';
          document.body.appendChild(a); a.click(); a.remove();
        }
        function removeItem(item){
          if(item.id === 'last'){
            localStorage.removeItem(SINGLE_KEY);
            setList([]);
            return;
          }
          const list = getList().filter(it => it.id !== item.id);
          setList(list);
        }
        function render(){
          const el = document.getElementById('fichas-list');
          const list = getList();
          el.innerHTML = '';
          if(!list.length){
            const p = document.createElement('p');
            p.textContent = 'No tienes fichas guardadas aún.';
            el.appendChild(p);
            return;
          }
          for(const it of list){
            const row = document.createElement('div'); row.className = 'ficha-item';
            const left = document.createElement('div');
            const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = (it.personaje && String(it.personaje).trim()) || 'Sin nombre';
            const sub = document.createElement('div'); sub.style.color='#6b7280'; sub.textContent = it.jugador ? ('Jugador: ' + it.jugador) : '';
            left.appendChild(title); left.appendChild(sub);
            const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
            const edit = document.createElement('a'); edit.className='btn'; edit.href='plantillas.html?fichaId=' + encodeURIComponent(it.id); edit.textContent='Editar';
            const dl = document.createElement('button'); dl.className='btn'; dl.type='button'; dl.textContent='Descargar';
            dl.addEventListener('click', function(){ download(it); });
            const del = document.createElement('button'); del.className='btn'; del.type='button'; del.textContent='Eliminar';
            del.addEventListener('click', function(){ removeItem(it); render(); });
            actions.appendChild(edit); actions.appendChild(dl); actions.appendChild(del);
            row.appendChild(left); row.appendChild(actions);
            el.appendChild(row);
          }
        }
        render();
      })();
    </script>
  </body>
</html>
